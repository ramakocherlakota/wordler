import mysql.connector

class Wordler:
    def __init__(self, guess_scores, scores_table="scores", hard_mode=False, debug=False):
        self.guess_scores = guess_scores
        self.scores_table = scores_table
        self.hard_mode = hard_mode
        self.debug = debug

    def db():
        return mysql.connector.connect(user='wordle', password='',
                                        host='127.0.0.1',
                                        database='wordle')
        
    def query(self, sql):
        if self.debug:
            print(sql)
        cursor = self.db().cursor()
        cursor.execute(sql)
        return cursor
            
    def get_score(self, target, guess):
        cursor = self.query(f"select score, 0 from {scores_table} where guess='{guess}' and answer='{target}'")
        for (score, ignore) in cursor:
            return score

    def next_guess(self):
        subqueries = []
        for guess_score in self.guess_scores:
            (guess, score) = guess_score
            subqueries.append(f"answer in (select answer from {scores_table} where guess='{guess}' and score='{score}')")            
            if self.hard_mode:
                subqueries.append(f"(select score from {self.scores_table} s where g.guess='{guess}' and s.answer=a.answer) = '{self.score}'");
        guess_subquery = " and " + " and ".join(subqueries)
        return f"select guess, sum(c * log(c) / log(2)) / sum(c) as h from (select g.guess, score, count(*) as c from {self.scores_table} a, guesses g where a.guess = g.guess {subquery} group by 1, 2) as t1 group by 1 order by 2 limit 1"
